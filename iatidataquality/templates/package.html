{% extends "layout.html" %}
{% block content %}
   <script src="/static/jquery.tablesorter.min.js"></script>
    <script >
    $(function() {
    $("table#packages").tablesorter({ sortList: [[0,0]] });
    $("table#publishers").tablesorter({ sortList: [[0,0]] });
    $("table#results").tablesorter({ sortList: [[0,0]] });
    });
    </script>
    {% if p[0] %}
    {% set grp = p[1] %}
    {% set pkg = p[0] %}
    {% else %}
    {% set pkg = p %}
    {% endif %}
	<h1>{{pkg.package_title}}<code>{{pkg.package_name}}</code></h1> 
    <table class="table" id="publishers">
    <tbody>
    <tr>
	<td>Package name</td><td>{{ pkg.package_name }}</td>
    </tr>
    <tr>
    <td>Package title</td><td>{{ pkg.package_title }}</td>
    </tr>
    <tr>
    <td>Package country</td><td>{{ pkg.package_country }}</td>
    </tr>
    {% if grp is defined %}
    <tr>
    <td>Package group</td><td><a href="{{url_for('publisher', id=grp.name)}}">{{ grp.name }}</a></td>
    </tr>
    {% endif %}
    <tr>
    <td>Link</td><td><a href="http://iatiregistry.org/dataset/{{pkg.package_name}}">http://iatiregistry.org/dataset/{{ pkg.package_name }}</a></td>
    </tr>
    </tbody>
    </table>

    {% if not latest %}
    <div class="alert alert-block alert-latest">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    <h4>Not showing the latest data.</h4>
    Activity-level information is only available for the latest data.
    <p><a class="btn btn-primary" href="{{url_for('packages', id=pkg.package_name)}}">Show latest</a></p>
    </div>{% endif %}
    
    <div class="pull-right testruns">
        <a class="btn" href="#runtimesmodal" data-toggle="modal" role="button">All test runs</a>
        <div id="runtimesmodal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h3 id="myModalLabel">Display results from another runtime</h3>
            </div>
            <div class="modal-body">
                <table class="table" id="runtimes_table">
                    <thead>
                    <th>ID</th><th>Date</th>
                    </thead>
                    <tbody>
                    {% for runtime in runtimes %}
                    <tr>
	                <td><a href="{{url_for('packages', id=pkg.package_name, runtime_id=runtime.runtime_id)}}">{{runtime.runtime_id}}</a></td><td>{{ runtime.runtime_datetime }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
             <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
            </div>
        </div>
    </div>

    <h1>{% if latest %}Latest results{%else%}Runtime {{latest_runtime.id}}{%endif%} <code>{{latest_runtime.runtime_datetime}}</code></h1>
    {% for h, values in results.items() %}
    <fieldset><legend>Hierarchy <small>{{h}}</small></legend>
    <table class="table" id="results">
    <thead>
    <th>Test</th><th>% Passed</th><th>Total results</th><th>Schedule</th>{% if latest %}<th>Details</th>{%endif%}
    </thead>
    <tbody>
    {% for test, result in values.items() %}
    <tr id="tr{{result[0].id}}h{{h}}" class="group-{% if result.group %}{{result.group}}{% else %}unknown{%endif%}">
	<td><a href="{{url_for('tests', id=result[0].id)}}">{{ result[0].description }}</a></td>
    <td class="pct">{{result[1]|round|int}}</td>
    <td>{{result[2]}}</td>
    <td class="schedule"></td>
    {% if latest%}<td><a href="#" class="showResult" id="result{{result[0].id}}hierarchy{{h}}"><i class="icon-chevron-down"></i></a></td>{%endif%}
    </tr>
    {% endfor%}
    </tbody>
    </table>
    </fieldset>
    {% endfor %}
<script>

    $(".showResult").click(function(e){
        if ($(this).hasClass("visible")) {
            e.preventDefault();


            re=new RegExp("result([0-9]*)hierarchy([0-9]|[A-z]*)");
            r=re.exec(this.id);

            result_id = r[1]
            hierarchy_id=r[2]

            $(this).removeClass("visible").html('<i class="icon-chevron-down"></i>');
            $("#tr"+result_id+"h"+hierarchy_id).next().slideUp('slow').delay(5000).remove();
        } else {
            e.preventDefault();

            re=new RegExp("result([0-9]*)hierarchy([0-9]|[A-z]*)");
            r=re.exec(this.id);

            result_id = r[1]
            hierarchy_id=r[2]
            $("#tr"+result_id+"h"+hierarchy_id).after('<tr class="hidden-results-tr" id="tr-result-' + result_id + '"><td colspan="5"></td></tr>');
            $.getJSON("/api/packages/{{pkg.package_name}}/hierarchy/" + hierarchy_id + "/tests/" + result_id + "/activities", function(data){
                var items = [];
                $.each(data, function(key, val){
                    if (val == '1') {
                        var status="PASS";
                        var statusclass="success";
                    } else {
                        var status="FAIL";
                        var statusclass="error";
                    }
                    items.push('<tr id="' + val + '" class="' + statusclass + '"><td><a href="http://beta.openaidsearch.org/explore-detail/?id=' + key + '">'+key+'</a></td><td>' + status + '</td></tr>');
                });
                $('<table/>', {
                    html: items.join('')
                  }).appendTo("#tr-result-"+result_id+" td");
                $("#tr-result-"+result_id).slideDown("slow");
            });
            $(this).addClass("visible").html('<i class="icon-chevron-up"></i>');
    }
    });
    $.getJSON("/api/publishers/{{grp.publisher_iati_id}}", function(data){
                var items = [];
                $.each(data["data"], function(key, val){
                    element = val["element"]
                    if (val["status"] =='fp') { status = '<i class="icon-wrench" title="Future publication"></i>'; }
                    if (val["status"] =='uc') { status = '<i class="icon-remove" title="Uncompliant"></i>'; }
                    if (val["status"] =='fc') { status = '<i class="icon-ok" title="Fully compliant"></i>'; }
                    if (val["status"] =='up') { status = '<i class="icon-remove" title="Unable to publish"></i>'; }
                    if (val["status"] =='pc') { status = '<i class="icon-flag" title="Partially compliant"></i>'; }

                    $(".group-" + element + " td.schedule").html('<span title="' + val["publication_date"] + ': ' + val["notes"] + '">' + status + '</span>');
                });
    });
    var showZero;
    $("#showZero").click(function(e){
        $(".zeroresults").toggle();
        if (showZero == true) {
            showZero = false;
            $(this).text("Show tests with zero results");
        } else {
            showZero = true;
            $(this).text("Hide tests with zero results");
        }
    });
</script>

{% endblock %}
